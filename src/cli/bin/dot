#!/usr/bin/env bash
set -euo pipefail

# dot - unified dotfiles CLI dispatcher
# Provides dynamic subcommand discovery and central configuration.

# =============================================================================
# LOAD CONSTANTS AND CONFIGURATION
# =============================================================================

# Auto-detect DOTFILES_ROOT (repository root)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"

# Set up directory structure
# bin/dot is at src/cli/bin/, so:
# ../.. from bin = src/
# ../../.. from bin = repo root
export DOTFILES_ROOT
DOTFILES_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
export SRC_DIR="$DOTFILES_ROOT/src"
export CLI_DIR="$SRC_DIR/cli"
export LIB_DIR="$SRC_DIR/lib"
export CORE_DIR="$SRC_DIR/core"
export COMMANDS_DIR="$CLI_DIR/commands"
export COMPONENTS_DIR="$SRC_DIR/components"
export CONFIGS_DIR="$SRC_DIR/configs"

# Set default paths
export DOTFILES_LEDGER="${DOTFILES_LEDGER:-$HOME/.dotfiles.ledger}"
export DOTFILES_BACKUP_DIR="${DOTFILES_BACKUP_DIR:-$HOME/.dotfiles.backup}"

# Enable debug mode if requested
[[ "${DOTFILES_DEBUG:-0}" == "1" ]] && set -x

# Load generic libraries
if [[ -f "$LIB_DIR/index.sh" ]]; then
  # shellcheck source=../../../lib/index.sh
  source "$LIB_DIR/index.sh"
else
  echo "Error: Cannot find lib/index.sh at $LIB_DIR/index.sh" >&2
  exit 1
fi

# Load domain-specific core
if [[ -f "$CORE_DIR/index.sh" ]]; then
  # shellcheck source=../../../core/index.sh
  source "$CORE_DIR/index.sh"
else
  echo "Error: Cannot find core/index.sh at $CORE_DIR/index.sh" >&2
  exit 1
fi

# Initialize ledger file
if [[ ! -f "$DOTFILES_LEDGER" ]]; then
  touch "$DOTFILES_LEDGER"
fi

# Debug info
if [[ "${DOTFILES_DEBUG:-0}" == "1" ]]; then
  echo "DOTFILES_ROOT: $DOTFILES_ROOT" >&2
  echo "SRC_DIR: $SRC_DIR" >&2
  echo "CLI_DIR: $CLI_DIR" >&2
  echo "LIB_DIR: $LIB_DIR" >&2
  echo "CORE_DIR: $CORE_DIR" >&2
  echo "COMMANDS_DIR: $COMMANDS_DIR" >&2
  echo "COMPONENTS_DIR: $COMPONENTS_DIR" >&2
  echo "CONFIGS_DIR: $CONFIGS_DIR" >&2
  echo "DOTFILES_LEDGER: $DOTFILES_LEDGER" >&2
fi

# =============================================================================
# CLI FUNCTIONS
# =============================================================================

usage() {
  echo "dot <command> [args...]" >&2
  echo "" >&2
  echo "Commands:" >&2

  # Function to find and list commands recursively
  find_and_list_commands() {
    local dir="$1"
    local category="$2"

    # Find all .sh files in subdirectories
    local files=()
    while IFS= read -r -d '' file; do
      files+=("$file")
    done < <(find "$dir" -type f -name "*.sh" -print0 | sort -z)

    if [ ${#files[@]} -gt 0 ] && [ -n "$category" ]; then
      echo "" >&2
      echo "  ${category}:" >&2
    fi

    for f in "${files[@]}"; do
      local name summary group
      name="$(basename "$f" .sh)"
      summary="$(grep -E '^# summary:' "$f" | head -1 | sed 's/# summary:[[:space:]]*//' || true)"
      group="$(grep -E '^# group:' "$f" | head -1 | sed 's/# group:[[:space:]]*//' || true)"
      printf "    %-18s %s\n" "$name" "${summary:-}" >&2
    done
  }

  # List commands from each subdirectory
  find_and_list_commands "$COMMANDS_DIR/diagnostic" "Diagnostic"
  find_and_list_commands "$COMMANDS_DIR/component" "Components"
  find_and_list_commands "$COMMANDS_DIR/maintenance" "Maintenance"

  echo "" >&2
  echo "Use 'dot help <command>' for details." >&2
}

help_cmd() {
  local target="$1"

  # Search for command in subdirectories
  local file=""
  for subdir in "$COMMANDS_DIR"/*; do
    [ -d "$subdir" ] || continue
    local candidate="$subdir/$target.sh"
    if [ -f "$candidate" ]; then
      file="$candidate"
      break
    fi
  done

  if [ -z "$file" ]; then
    echo "Unknown command: $target" >&2
    exit 1
  fi

  awk '/^# usage:/{print substr($0,3)} /^# summary:/{print substr($0,3)} /^# aliases:/{print substr($0,3)}' "$file"
  echo
  echo "Source: $(echo "$file" | sed "s|$PROJECT_ROOT/||")"
}

# =============================================================================
# MAIN CLI DISPATCHER
# =============================================================================

if [ $# -eq 0 ]; then
  usage; exit 1
fi

case "$1" in
  help)
    shift || true
    if [ $# -eq 0 ]; then usage; exit 0; fi
    help_cmd "$1"; exit 0;
    ;;
  --version|-v)
    echo "dot (scaffold) 0.0.1"; exit 0;
    ;;
  -h|--help)
    usage; exit 0;
    ;;
esac

cmd="$1"; shift || true

# Search for command file in subdirectories
cmd_file=""
for subdir in "$COMMANDS_DIR"/*; do
  [ -d "$subdir" ] || continue
  candidate="$subdir/$cmd.sh"
  if [ -f "$candidate" ]; then
    cmd_file="$candidate"
    break
  fi
done

if [ -z "$cmd_file" ]; then
  echo "Unknown command: $cmd" >&2
  echo "Run 'dot help' to list commands." >&2
  exit 1
fi

# shellcheck source=/dev/null
source "$cmd_file"
