#!/bin/bash
# shellcheck disable=SC1073,SC1036,SC1072
# Disabled: test expression parsing (zsh globbing syntax not compatible with bash)

# Shell configuration for macOS and Linux compatibility
# Optimized shell configuration with performance optimizations

# Detect dotfiles repository location (auto-detect from symlink)
if [[ -z "$DOTFILES_ROOT" ]]; then
  if [[ -L "$HOME/.zshrc" ]]; then
    # Follow symlink to get dotfiles repo location
    DOTFILES_ROOT="$(cd "$(dirname "$(readlink "$HOME/.zshrc")")/.." && pwd)"
  else
    # Fallback to standard location
    DOTFILES_ROOT="${HOME}/.dotfiles"
  fi
fi
export DOTFILES_ROOT

# Detect shell for compatibility
if [[ -n "$ZSH_VERSION" ]]; then
  # Zsh-specific settings
  HISTFILE=${HISTFILE:-$HOME/.zsh_history}
  HISTSIZE=50000
  SAVEHIST=50000
  setopt HIST_IGNORE_DUPS HIST_IGNORE_ALL_DUPS HIST_REDUCE_BLANKS HIST_FIND_NO_DUPS SHARE_HISTORY INC_APPEND_HISTORY
elif [[ -n "$BASH_VERSION" ]]; then
  # Bash-specific settings
  HISTFILE=${HISTFILE:-$HOME/.bash_history}
  HISTSIZE=50000
  HISTFILESIZE=50000
  shopt -s histappend
  export HISTCONTROL=ignoredups:erasedups
fi

# Load shell utilities from dotfiles repo or HOME (via symlinks)
[[ -f "$DOTFILES_ROOT/shell/lazy" ]] && source "$DOTFILES_ROOT/shell/lazy" || [[ -f "$HOME/.zsh_lazy" ]] && source "$HOME/.zsh_lazy"

# Load performance optimizations
[[ -f "$DOTFILES_ROOT/shell/performance" ]] && source "$DOTFILES_ROOT/shell/performance" || [[ -f "$HOME/.zsh_performance" ]] && source "$HOME/.zsh_performance"

# Load safety mechanisms (process monitoring and cleanup)
[[ -f "$DOTFILES_ROOT/shell/safety" ]] && source "$DOTFILES_ROOT/shell/safety" || [[ -f "$HOME/.zsh_safety" ]] && source "$HOME/.zsh_safety"

# Setup extended PATH if deferred (guarded for function existence)
if [[ "$DEFER_PATH_SETUP" == "1" ]] && typeset -f setup_extended_path >/dev/null; then
  setup_extended_path
fi

# Native Zsh completions with performance optimizations
autoload -Uz compinit

# Only rebuild completions once per day and use cache
local zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
if [[ $zcompdump(#qNmh+24) ]]; then
  compinit -C -d "$zcompdump"  # Skip security check and specify dump file
else
  compinit -d "$zcompdump"
  # Compile the completion dump for faster loading
  [[ -f "$zcompdump" && ! -f "${zcompdump}.zwc" ]] && zcompile "$zcompdump"
fi

# Enable completion features
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' # Case insensitive
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' special-dirs true

# Load plugins (if installed)
if [[ -d "$ZSH_PLUGINS" ]]; then
  # Load syntax highlighting
  [[ -f "$ZSH_PLUGINS/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh" ]] && \
    source "$ZSH_PLUGINS/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh"

  # Load autosuggestions
  [[ -f "$ZSH_PLUGINS/zsh-autosuggestions/zsh-autosuggestions.zsh" ]] && \
    source "$ZSH_PLUGINS/zsh-autosuggestions/zsh-autosuggestions.zsh"

  # Load fzf-tab
  [[ -f "$ZSH_PLUGINS/fzf-tab/fzf-tab.plugin.zsh" ]] && \
    source "$ZSH_PLUGINS/fzf-tab/fzf-tab.plugin.zsh"
fi

# Basic git aliases (previously from Oh My Zsh git plugin)
alias gst='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git pull'
alias gd='git diff'
alias gco='git checkout'
alias gb='git branch'
alias glog='git log --oneline --graph --decorate'

# Optimized aliases
if command -v eza >/dev/null 2>&1; then
  alias ll='eza -laF --group-directories-first'
  alias la='eza -A'
  alias l='eza -CF'
else
  alias ll='ls -laF'
  alias la='ls -A'
  alias l='ls -CF'
fi

# Source additional configurations
[[ -f "$DOTFILES_ROOT/shell/aliases" ]] && source "$DOTFILES_ROOT/shell/aliases" || [[ -f "$HOME/.zsh_aliases" ]] && source "$HOME/.zsh_aliases"
[[ -f "$DOTFILES_ROOT/shell/functions" ]] && source "$DOTFILES_ROOT/shell/functions" || [[ -f "$HOME/.zsh_functions" ]] && source "$HOME/.zsh_functions"

# FZF integration (if installed)
if command -v fzf >/dev/null 2>&1; then
  [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
  export FZF_DEFAULT_COMMAND='rg --files --hidden --glob "!{.git,node_modules}"'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi

# Conditional prompt initialization
if command -v starship >/dev/null 2>&1 && [[ -n "$STARSHIP_CONFIG" ]]; then
  # Starship prompt
  eval "$(starship init zsh)"
else
  # Simple fallback prompt
  PROMPT='%F{cyan}%n@%m%f:%F{yellow}%~%f%# '
fi

# Conditional tool initialization (customize as needed)
command -v direnv >/dev/null 2>&1 && eval "$(direnv hook zsh)"

# VS Code shell integration
[[ "$TERM_PROGRAM" == "vscode" ]] && command -v code >/dev/null 2>&1 && . "$(code --locate-shell-integration-path zsh)"

# Add your custom tool integrations here
# Examples:
# export GOENV_ROOT="$HOME/.goenv"
# export PATH="$GOENV_ROOT/bin:$PATH"
# eval "$(goenv init -)"
#
# [ -f "$HOME/.custom_env.sh" ] && source "$HOME/.custom_env.sh"
